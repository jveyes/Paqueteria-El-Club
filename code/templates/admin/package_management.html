<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Paquetes - PAQUETES EL CLUB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">📦 Gestión de Paquetes</h1>
            <p class="text-blue-100 mt-2">Administra el flujo de paquetes del sistema</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Filtros y Estadísticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">📊 Total Paquetes</h3>
                <p class="text-3xl font-bold text-blue-600" id="total-packages">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">📨 Anunciados</h3>
                <p class="text-3xl font-bold text-yellow-600" id="announced-packages">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">📥 Recibidos</h3>
                <p class="text-3xl font-bold text-blue-600" id="received-packages">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">✅ Entregados</h3>
                <p class="text-3xl font-bold text-green-600" id="delivered-packages">-</p>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="flex flex-wrap gap-4 items-center">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado:</label>
                    <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos los estados</option>
                        <option value="anunciado">Anunciado</option>
                        <option value="recibido">Recibido</option>
                        <option value="entregado">Entregado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar:</label>
                    <input type="text" id="search-input" placeholder="Cliente o tracking..." class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="ml-auto">
                    <button onclick="loadPackages()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        🔄 Actualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de Paquetes -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">Lista de Paquetes</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tracking</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Costo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="packages-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Los paquetes se cargarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal de Cambio de Estado -->
    <div id="status-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4" id="modal-title">Cambiar Estado</h3>
                <div id="modal-content">
                    <!-- El contenido se cargará dinámicamente -->
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeStatusModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="confirm-action-btn" class="px-4 py-2 text-white rounded-md hidden">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Historial -->
    <div id="history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Historial del Paquete</h3>
                <div id="history-content">
                    <!-- El historial se cargará dinámicamente -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeHistoryModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentPackageId = null;
        let currentAction = null;

        // Cargar paquetes al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadPackages();
            loadStats();
        });

        // Función para cargar paquetes
        async function loadPackages() {
            try {
                const statusFilter = document.getElementById('status-filter').value;
                const searchQuery = document.getElementById('search-input').value;
                
                let url = '/api/packages/';
                const params = new URLSearchParams();
                
                if (statusFilter) {
                    params.append('status_filter', statusFilter);
                }
                if (searchQuery) {
                    params.append('search', searchQuery);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const packages = await response.json();
                displayPackages(packages);
                
            } catch (error) {
                console.error('Error cargando paquetes:', error);
                showError('Error al cargar los paquetes');
            }
        }

        // Función para mostrar paquetes en la tabla
        function displayPackages(packages) {
            const tbody = document.getElementById('packages-table-body');
            tbody.innerHTML = '';

            if (packages.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            No se encontraron paquetes
                        </td>
                    </tr>
                `;
                return;
            }

            packages.forEach(package => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusBadge = getStatusBadge(package.status);
                const actions = getActionButtons(package);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${package.tracking_number}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${package.customer_name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${package.customer_phone}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${package.total_cost.toLocaleString()}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${actions}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Función para obtener el badge de estado
        function getStatusBadge(status) {
            const badges = {
                'anunciado': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">📨 Anunciado</span>',
                'recibido': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">📥 Recibido</span>',
                'entregado': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">✅ Entregado</span>',
                'cancelado': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">❌ Cancelado</span>'
            };
            return badges[status] || `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">${status}</span>`;
        }

        // Función para obtener botones de acción
        function getActionButtons(package) {
            let buttons = '';
            
            // Botón de historial (siempre disponible)
            buttons += `<button onclick="showHistory('${package.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Ver historial">📋</button>`;
            
            // Botones según el estado actual
            switch (package.status) {
                case 'anunciado':
                    buttons += `<button onclick="showStatusModal('${package.id}', 'receive')" class="text-green-600 hover:text-green-900 mr-2" title="Marcar como recibido">📥</button>`;
                    buttons += `<button onclick="showStatusModal('${package.id}', 'cancel')" class="text-red-600 hover:text-red-900" title="Cancelar">❌</button>`;
                    break;
                case 'recibido':
                    buttons += `<button onclick="showStatusModal('${package.id}', 'deliver')" class="text-green-600 hover:text-green-900 mr-2" title="Marcar como entregado">✅</button>`;
                    buttons += `<button onclick="showStatusModal('${package.id}', 'cancel')" class="text-red-600 hover:text-red-900" title="Cancelar">❌</button>`;
                    break;
                case 'entregado':
                    buttons += `<span class="text-gray-400" title="Paquete completado">✓</span>`;
                    break;
                case 'cancelado':
                    buttons += `<span class="text-gray-400" title="Paquete cancelado">✗</span>`;
                    break;
            }
            
            return buttons;
        }

        // Función para mostrar modal de cambio de estado
        function showStatusModal(packageId, action) {
            currentPackageId = packageId;
            currentAction = action;
            
            const modal = document.getElementById('status-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            const confirmBtn = document.getElementById('confirm-action-btn');
            
            // Configurar según la acción
            switch (action) {
                case 'receive':
                    title.textContent = 'Marcar como Recibido';
                    content.innerHTML = `
                        <p class="text-gray-600 mb-4">¿Estás seguro de que quieres marcar este paquete como RECIBIDO?</p>
                        <p class="text-sm text-gray-500">Esta acción cambiará el estado del paquete y registrará la fecha de recepción.</p>
                    `;
                    confirmBtn.className = 'px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 hidden';
                    confirmBtn.textContent = 'Confirmar Recepción';
                    confirmBtn.onclick = () => changePackageStatus('receive');
                    break;
                    
                case 'deliver':
                    title.textContent = 'Marcar como Entregado';
                    content.innerHTML = `
                        <p class="text-gray-600 mb-4">¿Estás seguro de que quieres marcar este paquete como ENTREGADO?</p>
                        <p class="text-sm text-gray-500">Esta acción cambiará el estado del paquete y registrará la fecha de entrega.</p>
                    `;
                    confirmBtn.className = 'px-4 py-2 text-white bg-green-600 rounded-md hover:bg-green-700 hidden';
                    confirmBtn.textContent = 'Confirmar Entrega';
                    confirmBtn.onclick = () => changePackageStatus('deliver');
                    break;
                    
                case 'cancel':
                    title.textContent = 'Cancelar Paquete';
                    content.innerHTML = `
                        <p class="text-gray-600 mb-4">¿Estás seguro de que quieres CANCELAR este paquete?</p>
                        <p class="text-sm text-gray-500">Esta acción cambiará el estado del paquete a CANCELADO. Esta operación no se puede deshacer.</p>
                    `;
                    confirmBtn.className = 'px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700 hidden';
                    confirmBtn.textContent = 'Confirmar Cancelación';
                    confirmBtn.onclick = () => changePackageStatus('cancel');
                    break;
            }
            
            confirmBtn.classList.remove('hidden');
            modal.classList.remove('hidden');
        }

        // Función para cerrar modal de estado
        function closeStatusModal() {
            document.getElementById('status-modal').classList.add('hidden');
            currentPackageId = null;
            currentAction = null;
        }

        // Función para cambiar estado del paquete
        async function changePackageStatus(action) {
            try {
                const response = await fetch(`/api/packages/${currentPackageId}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                    closeStatusModal();
                    loadPackages();
                    loadStats();
                } else {
                    showError(result.message || 'Error al cambiar el estado');
                }
                
            } catch (error) {
                console.error('Error cambiando estado:', error);
                showError('Error al cambiar el estado del paquete');
            }
        }

        // Función para mostrar historial
        async function showHistory(packageId) {
            try {
                const response = await fetch(`/api/packages/${packageId}/history`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                displayHistory(data);
                
            } catch (error) {
                console.error('Error cargando historial:', error);
                showError('Error al cargar el historial');
            }
        }

        // Función para mostrar historial en modal
        function displayHistory(data) {
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');
            
            let historyHtml = `
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Información del Paquete</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium">Tracking:</span> ${data.package.tracking_number}
                        </div>
                        <div>
                            <span class="font-medium">Cliente:</span> ${data.package.customer_name}
                        </div>
                        <div>
                            <span class="font-medium">Teléfono:</span> ${data.package.customer_phone}
                        </div>
                        <div>
                            <span class="font-medium">Estado:</span> ${getStatusBadge(data.package.status)}
                        </div>
                    </div>
                </div>
                
                <h4 class="text-lg font-medium text-gray-800 mb-4">Historial de Estados</h4>
                <div class="space-y-4">
            `;
            
            data.history.forEach((item, index) => {
                const timestamp = new Date(item.timestamp).toLocaleString('es-CO', {
                    timeZone: 'America/Bogota',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const statusIcon = {
                    'anunciado': '📨',
                    'recibido': '📥',
                    'entregado': '✅',
                    'cancelado': '❌'
                }[item.status] || '📋';
                
                historyHtml += `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-sm">${statusIcon}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">${item.description}</p>
                            <p class="text-sm text-gray-500">${timestamp}</p>
                            ${item.details ? `
                                <div class="mt-1 text-xs text-gray-400">
                                    ${Object.entries(item.details).map(([key, value]) => `${key}: ${value}`).join(' | ')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            historyHtml += '</div>';
            content.innerHTML = historyHtml;
            modal.classList.remove('hidden');
        }

        // Función para cerrar modal de historial
        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }

        // Función para cargar estadísticas
        async function loadStats() {
            try {
                const response = await fetch('/api/packages/', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const packages = await response.json();
                
                // Contar por estado
                const stats = packages.reduce((acc, pkg) => {
                    acc[pkg.status] = (acc[pkg.status] || 0) + 1;
                    return acc;
                }, {});
                
                document.getElementById('total-packages').textContent = packages.length;
                document.getElementById('announced-packages').textContent = stats.anunciado || 0;
                document.getElementById('received-packages').textContent = stats.recibido || 0;
                document.getElementById('delivered-packages').textContent = stats.entregado || 0;
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // Función para obtener token de autenticación
        function getAuthToken() {
            // Implementar según tu sistema de autenticación
            return localStorage.getItem('auth_token') || '';
        }

        // Funciones de utilidad para mostrar mensajes
        function showSuccess(message) {
            // Implementar notificación de éxito
            alert('✅ ' + message);
        }

        function showError(message) {
            // Implementar notificación de error
            alert('❌ ' + message);
        }

        // Event listeners para filtros
        document.getElementById('status-filter').addEventListener('change', loadPackages);
        document.getElementById('search-input').addEventListener('input', debounce(loadPackages, 300));

        // Función debounce para búsqueda
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
