{% extends "components/base-public.html" %}

{% block title %}Restablecer Contraseña - PAQUETES EL CLUB v3.1{% endblock %}

{% block extra_head %}
<!-- Estilos específicos para esta página -->
<style>
    /* Input con icono */
    .input-with-icon {
        position: relative;
    }
    
    .input-with-icon input {
        padding-left: 40px;
    }
    
    .input-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        width: 20px;
        height: 20px;
        z-index: 10;
    }

    /* Animación de carga para el botón */
    .loading {
        position: relative;
        color: transparent;
    }
    
    .loading::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8">
    <!-- Logo PAPYRUS -->
    <div class="text-center mb-8 px-4">
        <img src="/static/images/logo.png?v=3.1" 
             alt="PAPYRUS - Mucho más que solo papeles" 
             class="mx-auto w-full max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl h-auto object-contain mb-4"
             style="max-height: 120px; min-height: 80px;">
    </div>

    <!-- Contenedor centrado para el formulario -->
    <div class="flex justify-center">
        <div class="max-w-md w-full">
            <!-- Formulario de Restablecimiento de Contraseña -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
                <!-- Header del formulario -->
                <div class="border-b border-gray-100 px-4 sm:px-8 py-4 sm:py-6">
                    <div class="text-center">
                        <h2 class="text-xl sm:text-2xl font-light text-gray-900">Restablecer Contraseña</h2>
                        <p class="text-sm text-gray-500 mt-1">Ingresa tu nueva contraseña</p>
                    </div>
                </div>
                
                <!-- Contenido del formulario -->
                <div class="p-4 sm:p-8">
                    <form id="resetPasswordForm" class="space-y-6">
                        <!-- Nueva Contraseña -->
                        <div class="input-with-icon">
                            <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <input type="password" 
                                   id="new_password" 
                                   name="new_password" 
                                   required
                                   class="w-full px-0 py-3 border-0 border-b-2 border-gray-200 focus:border-papyrus-blue focus:ring-0 bg-transparent transition-colors text-sm sm:text-base"
                                   placeholder="Nueva contraseña">
                        </div>
                        
                        <!-- Confirmar Contraseña -->
                        <div class="input-with-icon">
                            <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <input type="password" 
                                   id="confirm_password" 
                                   name="confirm_password" 
                                   required
                                   class="w-full px-0 py-3 border-0 border-b-2 border-gray-200 focus:border-papyrus-blue focus:ring-0 bg-transparent transition-colors text-sm sm:text-base"
                                   placeholder="Confirmar contraseña">
                        </div>
                        
                        <!-- Información de seguridad -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-blue-800">Recomendaciones de Seguridad</h3>
                                    <div class="mt-2 text-sm text-blue-700">
                                        <ul class="list-disc list-inside space-y-1">
                                            <li>Usa al menos 8 caracteres</li>
                                            <li>Combina mayúsculas y minúsculas</li>
                                            <li>Incluye números y símbolos</li>
                                            <li>Evita información personal</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mensaje de error -->
                        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                            <div class="flex">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span id="errorText">Error en las credenciales</span>
                            </div>
                        </div>

                        <!-- Mensaje de éxito -->
                        <div id="successMessage" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm">
                            <div class="flex">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span id="successText">Contraseña restablecida exitosamente</span>
                            </div>
                        </div>
                        
                        <!-- Botón de Envío -->
                        <div class="pt-4">
                            <button type="submit" 
                                    id="resetButton"
                                    class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-base font-medium rounded-xl text-white bg-papyrus-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-papyrus-blue transition-all duration-300 shadow-md hover:shadow-lg">
                                <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                    <svg class="h-5 w-5 text-blue-200 group-hover:text-blue-100" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                </span>
                                <span id="resetButtonText">Restablecer Contraseña</span>
                            </button>
                        </div>

                        <!-- Enlace de regreso -->
                        <div class="text-center">
                            <a href="/auth/login" class="font-medium text-papyrus-blue hover:text-blue-700 transition-colors duration-200">
                                ← Volver al inicio de sesión
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Obtener elementos
        const resetButton = document.getElementById('resetButton');
        const resetButtonText = document.getElementById('resetButtonText');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const errorText = document.getElementById('errorText');
        const successText = document.getElementById('successText');
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        // Obtener token de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        console.log('Token extraído de URL:', token);
        console.log('URL completa:', window.location.href);

        if (!token) {
            showError('Token de restablecimiento no válido o expirado. Por favor, solicita un nuevo enlace de restablecimiento.');
            return;
        }
        
        // Validaciones básicas
        if (!newPassword || !confirmPassword) {
            showError('Por favor, completa todos los campos');
            return;
        }
        
        if (newPassword.length < 8) {
            showError('La contraseña debe tener al menos 8 caracteres');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showError('Las contraseñas no coinciden');
            return;
        }
        
        // Mostrar estado de carga
        resetButton.disabled = true;
        resetButton.classList.add('loading');
        resetButtonText.textContent = 'Procesando...';
        hideMessages();
        
        // Preparar payload
        const payload = {
            token: token,
            new_password: newPassword
        };
        
        console.log('Payload a enviar:', payload);
        
        // Realizar llamada a la API
        fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(`HTTP ${response.status}: ${errorData.detail || 'Error desconocido'}`);
                });
            }
            return response.json();
        })
        .then(data => {
            // Restablecimiento exitoso
            console.log('Restablecimiento exitoso:', data);
            
            // Mostrar mensaje de éxito
            showSuccess(data.message || 'Contraseña restablecida exitosamente. Redirigiendo al login...');
            console.log('Mensaje de éxito mostrado');
            
            // Deshabilitar el formulario y cambiar el botón
            document.getElementById('new_password').disabled = true;
            document.getElementById('confirm_password').disabled = true;
            
            // Cambiar el botón a estado de éxito
            const resetButton = document.getElementById('resetButton');
            const resetButtonText = document.getElementById('resetButtonText');
            if (resetButton && resetButtonText) {
                resetButton.disabled = true;
                resetButton.classList.remove('loading');
                resetButtonText.textContent = 'Contraseña Restablecida';
                resetButton.style.backgroundColor = '#28a745'; // Verde para éxito
                console.log('Botón cambiado a estado de éxito');
            }
            
            console.log('Formulario deshabilitado');
            
            // Redirigir al login después de 3 segundos
            setTimeout(() => {
                console.log('Redirigiendo al login...');
                window.location.href = '/auth/login';
            }, 3000);
        })
        .catch(error => {
            console.error('Error en restablecimiento:', error);
            
            // Restaurar el botón antes de mostrar el error
            resetButton();
            
            // Mostrar mensaje de error apropiado
            if (error.message.includes('400')) {
                showError('Token inválido o expirado. Por favor, solicita un nuevo enlace de restablecimiento.');
            } else if (error.message.includes('422')) {
                showError('Datos inválidos. Verifica que las contraseñas cumplan con los requisitos.');
            } else {
                showError('Error de conexión. Por favor, intenta nuevamente.');
            }
        });
    });
    
    function showError(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
        successMessage.classList.add('hidden');
    }
    
    function showSuccess(message) {
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        successText.textContent = message;
        successMessage.classList.remove('hidden');
        errorMessage.classList.add('hidden');
    }
    
    function hideMessages() {
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        errorMessage.classList.add('hidden');
        successMessage.classList.add('hidden');
    }
    
    function resetButton() {
        console.log('Función resetButton() ejecutándose...');
        const resetButton = document.getElementById('resetButton');
        const resetButtonText = document.getElementById('resetButtonText');
        
        if (resetButton && resetButtonText) {
            resetButton.disabled = false;
            resetButton.classList.remove('loading');
            resetButtonText.textContent = 'Restablecer Contraseña';
            console.log('Botón restaurado correctamente');
        } else {
            console.error('Error: No se encontraron los elementos del botón');
        }
    }
    
    // Limpiar mensajes cuando el usuario empiece a escribir
    document.getElementById('new_password').addEventListener('input', hideMessages);
    document.getElementById('confirm_password').addEventListener('input', hideMessages);
    
    // Focus automático en el campo de nueva contraseña al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        const newPasswordField = document.getElementById('new_password');
        if (newPasswordField) {
            newPasswordField.focus();
        }
    });
</script>
{% endblock %}
