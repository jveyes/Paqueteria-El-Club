{% extends "components/base-public.html" %}

{% block title %}Crear Cuenta - PAQUETES EL CLUB v3.1{% endblock %}

{% block extra_head %}
<!-- Estilos específicos para esta página -->
<style>
    /* Input con icono */
    .input-with-icon {
        position: relative;
    }
    
    .input-with-icon input {
        padding-left: 40px;
    }
    
    .input-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        width: 20px;
        height: 20px;
        z-index: 10;
    }

    /* Animación de carga para el botón */
    .loading {
        position: relative;
        color: transparent;
    }
    
    .loading::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Indicador de fortaleza de contraseña */
    .password-strength {
        height: 4px;
        border-radius: 2px;
        transition: all 0.3s ease;
    }
    
    .strength-weak { background-color: #ef4444; }
    .strength-medium { background-color: #f59e0b; }
    .strength-strong { background-color: #10b981; }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Logo PAPYRUS -->
        <div class="text-center">
            <img src="/static/images/papyrus-logo.png" 
                 alt="PAPYRUS - Mucho más que solo papeles" 
                 class="mx-auto w-full max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl h-auto object-contain"
                 style="max-height: 120px; min-height: 80px;">
            <h2 class="mt-6 text-3xl font-light text-gray-900">
                Crear Cuenta
            </h2>
            <p class="mt-2 text-sm text-gray-600">
                Únete a PAQUETES EL CLUB
            </p>
        </div>

        <!-- Formulario de Registro -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8">
            <form id="registerForm" class="space-y-6">
                <!-- Nombre completo -->
                <div class="input-with-icon">
                    <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <input type="text" 
                           id="full_name" 
                           name="full_name" 
                           required
                           class="w-full px-0 py-3 border-0 border-b-2 border-gray-200 focus:border-papyrus-blue focus:ring-0 bg-transparent transition-colors text-sm sm:text-base"
                           placeholder="Nombre completo">
                </div>
                
                <!-- Email -->
                <div class="input-with-icon">
                    <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                    </svg>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           required
                           class="w-full px-0 py-3 border-0 border-b-2 border-gray-200 focus:border-papyrus-blue focus:ring-0 bg-transparent transition-colors text-sm sm:text-base"
                           placeholder="Correo electrónico">
                </div>
                
                <!-- Teléfono -->
                <div class="input-with-icon">
                    <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <input type="tel" 
                           id="phone" 
                           name="phone" 
                           required
                           class="w-full px-0 py-3 border-0 border-b-2 border-gray-200 focus:border-papyrus-blue focus:ring-0 bg-transparent transition-colors text-sm sm:text-base"
                           placeholder="Número de teléfono">
                </div>
                
                <!-- Contraseña -->
                <div class="input-with-icon">
                    <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <input type="password" 
                           id="password" 
                           name="password" 
                           required
                           class="w-full px-0 py-3 border-0 border-b-2 border-gray-200 focus:border-papyrus-blue focus:ring-0 bg-transparent transition-colors text-sm sm:text-base"
                           placeholder="Contraseña">
                </div>
                
                <!-- Indicador de fortaleza de contraseña -->
                <div class="password-strength-container">
                    <div class="password-strength" id="passwordStrength"></div>
                    <p class="text-xs text-gray-500 mt-1" id="passwordHint">La contraseña debe tener al menos 8 caracteres</p>
                </div>
                
                <!-- Confirmar contraseña -->
                <div class="input-with-icon">
                    <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <input type="password" 
                           id="confirm_password" 
                           name="confirm_password" 
                           required
                           class="w-full px-0 py-3 border-0 border-b-2 border-gray-200 focus:border-papyrus-blue focus:ring-0 bg-transparent transition-colors text-sm sm:text-base"
                           placeholder="Confirmar contraseña">
                </div>
                
                <!-- Términos y condiciones -->
                <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center h-5">
                        <input id="terms_conditions" 
                               name="terms_conditions" 
                               type="checkbox" 
                               required
                               class="h-4 w-4 text-papyrus-blue focus:ring-papyrus-blue border-gray-300 rounded">
                    </div>
                    <div class="text-sm">
                        <label for="terms_conditions" class="font-medium text-gray-700">
                            Acepto los términos y condiciones *
                        </label>
                        <p class="text-gray-500 mt-1">
                            Al marcar esta casilla, confirmo que he leído y acepto los 
                            <a href="/static/documents/TERMINOS%20Y%20CONDICIONES%20PAQUETES.pdf" target="_blank" class="text-papyrus-blue hover:text-blue-700 underline">términos y condiciones</a> 
                            del servicio.
                        </p>
                    </div>
                </div>
                
                <!-- Mensaje de error -->
                <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    <div class="flex">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="errorText">Error en el registro</span>
                    </div>
                </div>
                
                <!-- Botón de Envío -->
                <div class="pt-4">
                    <button type="submit" 
                            id="registerButton"
                            class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-base font-medium rounded-xl text-white bg-papyrus-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-papyrus-blue transition-all duration-300 shadow-md hover:shadow-lg">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-blue-200 group-hover:text-blue-100" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                            </svg>
                        </span>
                        <span id="registerButtonText">Crear Cuenta</span>
                    </button>
                </div>
            </form>
            
            <!-- Separador -->
            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">¿Ya tienes una cuenta?</span>
                    </div>
                </div>
            </div>
            
            <!-- Botón de Login -->
            <div class="mt-6">
                <a href="/auth/login" 
                   class="w-full flex justify-center py-3 px-4 border border-gray-300 rounded-xl shadow-sm text-base font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-papyrus-blue transition-all duration-300">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                    </svg>
                    Iniciar Sesión
                </a>
            </div>
        </div>
        
        <!-- Enlaces adicionales -->
        <div class="text-center">
            <p class="text-sm text-gray-600">
                ¿Necesitas ayuda? 
                <a href="/help" class="font-medium text-papyrus-blue hover:text-blue-700">
                    Contacta con soporte
                </a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Obtener elementos
        const registerButton = document.getElementById('registerButton');
        const registerButtonText = document.getElementById('registerButtonText');
        const errorMessage = document.getElementById('errorMessage');
        
        // Obtener valores
        const fullName = document.getElementById('full_name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const termsAccepted = document.getElementById('terms_conditions').checked;
        
        // Validaciones
        if (!fullName || !email || !phone || !password || !confirmPassword) {
            showError('Por favor, completa todos los campos');
            return;
        }
        
        if (!isValidEmail(email)) {
            showError('Por favor, ingresa un correo electrónico válido');
            return;
        }
        
        if (password.length < 8) {
            showError('La contraseña debe tener al menos 8 caracteres');
            return;
        }
        
        if (password !== confirmPassword) {
            showError('Las contraseñas no coinciden');
            return;
        }
        
        if (!termsAccepted) {
            showError('Debes aceptar los términos y condiciones');
            return;
        }
        
        // Mostrar estado de carga
        registerButton.disabled = true;
        registerButton.classList.add('loading');
        registerButtonText.textContent = 'Creando cuenta...';
        hideError();
        
        // Preparar datos para el registro
        const userData = {
            username: email, // Usar email como username
            email: email,
            password: password,
            first_name: fullName.split(' ')[0] || fullName,
            last_name: fullName.split(' ').slice(1).join(' ') || '',
            phone: phone,
            role: "user" // Por defecto, los usuarios registrados son "user"
        };
        
        // Realizar llamada a la API de registro
        fetch('/api/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            // Registro exitoso
            console.log('Registro exitoso:', data);
            showSuccess('¡Cuenta creada exitosamente! Redirigiendo al login...');
            
            // Redirigir al login después de 2 segundos
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
        })
        .catch(error => {
            console.error('Error en registro:', error);
            
            // Mostrar mensaje de error apropiado
            if (error.message.includes('ya existe')) {
                showError('El usuario o email ya existe. Por favor, usa otro email o inicia sesión.');
            } else if (error.message.includes('400')) {
                showError('Datos inválidos. Por favor, verifica la información ingresada.');
            } else if (error.message.includes('422')) {
                showError('Datos de formulario inválidos. Por favor, verifica todos los campos.');
            } else {
                showError('Error al crear la cuenta. Por favor, intenta nuevamente.');
            }
            
            resetButton();
        });
    });
    
    function resetButton() {
        const registerButton = document.getElementById('registerButton');
        const registerButtonText = document.getElementById('registerButtonText');
        registerButton.disabled = false;
        registerButton.classList.remove('loading');
        registerButtonText.textContent = 'Crear Cuenta';
    }
    
    // Validación de fortaleza de contraseña
    document.getElementById('password').addEventListener('input', function(e) {
        const password = e.target.value;
        const strengthBar = document.getElementById('passwordStrength');
        const hint = document.getElementById('passwordHint');
        
        let strength = 0;
        let hintText = '';
        
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/)) strength++;
        if (password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;
        if (password.match(/[^a-zA-Z0-9]/)) strength++;
        
        strengthBar.className = 'password-strength';
        
        if (strength < 2) {
            strengthBar.classList.add('strength-weak');
            hintText = 'Contraseña débil';
        } else if (strength < 4) {
            strengthBar.classList.add('strength-medium');
            hintText = 'Contraseña media';
        } else {
            strengthBar.classList.add('strength-strong');
            hintText = 'Contraseña fuerte';
        }
        
        hint.textContent = hintText;
    });
    
    function showError(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
        errorMessage.classList.remove('bg-green-50', 'border-green-200', 'text-green-700');
        errorMessage.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
    }
    
    function showSuccess(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
        errorMessage.classList.remove('bg-red-50', 'border-red-200', 'text-red-700');
        errorMessage.classList.add('bg-green-50', 'border-green-200', 'text-green-700');
    }
    
    function hideError() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.classList.add('hidden');
    }
    
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    // Limpiar error cuando el usuario empiece a escribir
    document.getElementById('full_name').addEventListener('input', hideError);
    document.getElementById('email').addEventListener('input', hideError);
    document.getElementById('phone').addEventListener('input', hideError);
    document.getElementById('password').addEventListener('input', hideError);
    document.getElementById('confirm_password').addEventListener('input', hideError);
</script>
{% endblock %}
