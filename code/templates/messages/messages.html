{% extends "components/base.html" %}

{% block title %}Mensajes - PAQUETES EL CLUB v3.1{% endblock %}

{% block content %}
<!-- Verificación de autenticación -->
{% if not is_authenticated %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-8 text-center">
        <div class="bg-gray-100 rounded-lg p-3 inline-flex mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900">Acceso Restringido</h3>
        <p class="mt-2 text-sm text-gray-500">Debes iniciar sesión para acceder a los mensajes.</p>
        <div class="mt-6">
            <a href="/auth/login" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-papyrus-blue hover:bg-blue-700 transition-colors duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                </svg>
                Iniciar Sesión
            </a>
        </div>
    </div>
</div>
{% else %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <div class="space-y-6">
        <!-- Header -->
        <div class="sm:flex sm:items-center sm:justify-between">
            <div>
                <h1 class="text-xl sm:text-2xl md:text-3xl font-light text-gray-900">Mensajes</h1>
                <p class="mt-2 text-sm text-gray-500">
                    Gestión de consultas y mensajes de clientes
                </p>
            </div>
            <div class="mt-4 sm:mt-0 flex space-x-3">
                <button id="refreshButton" 
                        class="inline-flex items-center px-3 py-2 md:px-4 md:py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-papyrus-blue">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Actualizar
                </button>
            </div>
        </div>

        <!-- Estadísticas -->
        <div id="messageStats" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 sm:mb-8">
            <!-- No Leídos (Mensajes Nuevos) -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-200">
                <div class="flex items-center space-x-3">
                    <div class="bg-red-100 rounded-lg p-2">
                        <svg class="w-6 h-6 text-papyrus-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide">No Leídos</h3>
                        <p id="unreadMessages" class="text-2xl font-bold text-gray-900">-</p>
                        <p class="text-xs text-gray-500">Mensajes nuevos</p>
                    </div>
                </div>
            </div>

            <!-- En Progreso -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-200">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-100 rounded-lg p-2">
                        <svg class="w-6 h-6 text-papyrus-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide">En Progreso</h3>
                        <p id="inProgressMessages" class="text-2xl font-bold text-gray-900">-</p>
                        <p class="text-xs text-gray-500">Gestionando solución</p>
                    </div>
                </div>
            </div>

            <!-- Resueltos -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-200">
                <div class="flex items-center space-x-3">
                    <div class="bg-green-100 rounded-lg p-2">
                        <svg class="w-6 h-6 text-papyrus-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide">Resueltos</h3>
                        <p id="resolvedMessages" class="text-2xl font-bold text-gray-900">-</p>
                        <p class="text-xs text-gray-500">Solucionados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-4 sm:p-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:space-x-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4 lg:mb-0 lg:flex-shrink-0">Filtros</h2>
                
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 flex-1">
                    <!-- Filtro por estado -->
                    <div class="relative flex-1 sm:max-w-xs">
                        <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue bg-white transition-colors appearance-none text-sm">
                            <option value="">Todos los estados</option>
                            <option value="unread">No Leídos</option>
                            <option value="pending">Pendientes</option>
                            <option value="in_progress">En Progreso</option>
                            <option value="resolved">Resueltos</option>
                            <option value="closed">Cerrados</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Búsqueda por cliente -->
                    <div class="relative flex-1 sm:max-w-xs">
                        <input id="searchFilter" 
                               type="text" 
                               placeholder="Buscar por nombre o teléfono..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue bg-white transition-colors text-sm">
                    </div>

                    <!-- Botón de limpiar filtros -->
                    <button id="clearFilters" 
                            class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-papyrus-blue">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Mensajes -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100">
            <div class="border-b border-gray-100 px-4 sm:px-8 py-4 sm:py-6">
                <h2 class="text-lg font-medium text-gray-900">Lista de Mensajes</h2>
            </div>
            <div class="p-4 sm:p-8">
                <div id="messagesList" class="space-y-4">
                    <!-- Los mensajes se cargarán aquí dinámicamente -->
                </div>

                <!-- Loading -->
                <div id="messagesLoading" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-papyrus-blue mx-auto"></div>
                    <p class="mt-2 text-sm text-gray-500">Cargando mensajes...</p>
                </div>

                <!-- Sin mensajes -->
                <div id="noMessages" class="text-center py-8 hidden">
                    <div class="bg-gray-100 rounded-lg p-3 inline-flex mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">No hay mensajes</h3>
                    <p class="mt-2 text-sm text-gray-500">No se encontraron mensajes con los filtros aplicados.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalle de Mensaje -->
<div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-4 sm:p-5 w-11/12 md:w-3/4 lg:w-1/2 max-w-4xl">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100">
            <div class="border-b border-gray-100 px-4 sm:px-8 py-4 sm:py-6 flex items-center justify-between">
                <h3 class="text-xl font-light text-gray-900">Detalle del Mensaje</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-4 sm:p-8">
                <div id="messageDetail" class="space-y-6">
                    <!-- El contenido del mensaje se cargará aquí -->
                </div>

                <!-- Formulario de respuesta -->
                <div id="responseForm" class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Responder al Mensaje</h4>
                    <textarea id="responseText" 
                              rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue transition-colors"
                              placeholder="Escribe tu respuesta..."></textarea>
                    <div class="mt-4 flex flex-col sm:flex-row sm:justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="cancelResponse" 
                                class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 hover:shadow-md transition-all duration-200">
                            Cancelar
                        </button>
                        <button id="sendResponse" 
                                class="w-full sm:w-auto px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-papyrus-blue hover:bg-blue-700 transition-colors duration-200">
                            <svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Enviar Respuesta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<style>
.line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}
</style>
<script>
let currentMessageId = null;

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página de mensajes cargada');
    const token = getAuthToken();
    console.log('Token disponible:', token ? 'Sí' : 'No');
    
    loadMessageStats();
    loadMessages();
    
    // Event listeners
    document.getElementById('refreshButton').addEventListener('click', function() {
        loadMessageStats();
        loadMessages();
    });
    
    document.getElementById('statusFilter').addEventListener('change', loadMessages);
    document.getElementById('searchFilter').addEventListener('input', loadMessages);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    
    // Modal events
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('cancelResponse').addEventListener('click', closeModal);
    document.getElementById('sendResponse').addEventListener('click', sendResponse);
});

function loadMessageStats() {
    const token = getAuthToken();
    
    if (!token) {
        console.error('No hay token de autenticación disponible');
        return;
    }
    
    fetch('/api/messages/stats', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('unreadMessages').textContent = data.unread_messages || 0;
        document.getElementById('inProgressMessages').textContent = data.pending_messages || 0;
        document.getElementById('resolvedMessages').textContent = data.resolved_messages || 0;
    })
    .catch(error => {
        console.error('Error cargando estadísticas:', error);
        // Mostrar valores por defecto en caso de error
        document.getElementById('unreadMessages').textContent = '0';
        document.getElementById('inProgressMessages').textContent = '0';
        document.getElementById('resolvedMessages').textContent = '0';
    });
}

function loadMessages() {
    const token = getAuthToken();
    
    if (!token) {
        console.error('No hay token de autenticación disponible');
        window.location.href = '/auth/login';
        return;
    }
    
    console.log('Cargando mensajes con token:', token ? 'presente' : 'ausente');
    
    document.getElementById('messagesLoading').classList.remove('hidden');
    document.getElementById('messagesList').innerHTML = '';
    document.getElementById('noMessages').classList.add('hidden');
    
    fetch('/api/messages/', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(messages => {
        console.log('Mensajes recibidos desde API:', messages);
        displayMessages(messages);
    })
    .catch(error => {
        console.error('Error cargando mensajes:', error);
        document.getElementById('messagesLoading').classList.add('hidden');
        document.getElementById('noMessages').classList.remove('hidden');
        
        // Mostrar mensaje de error
        const messagesList = document.getElementById('messagesList');
        messagesList.innerHTML = `
            <div class="text-center py-8">
                <div class="bg-red-100 rounded-lg p-3 inline-flex mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Error al cargar mensajes</h3>
                <p class="mt-2 text-sm text-gray-500">No se pudieron cargar los mensajes. Intenta recargar la página.</p>
            </div>
        `;
    });
}

function displayMessages(messages) {
    // Filtrar mensajes según los filtros aplicados
    let filteredMessages = [...messages];
    
    const statusFilter = document.getElementById('statusFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    if (statusFilter) {
        if (statusFilter === 'unread') {
            filteredMessages = filteredMessages.filter(m => !m.is_read);
        } else {
            filteredMessages = filteredMessages.filter(m => m.status === statusFilter);
        }
    }
    
    if (searchFilter) {
        filteredMessages = filteredMessages.filter(m => 
            (m.customer_name && m.customer_name.toLowerCase().includes(searchFilter)) ||
            (m.customer_phone && m.customer_phone.includes(searchFilter))
        );
    }
    
    document.getElementById('messagesLoading').classList.add('hidden');
    
    const messagesList = document.getElementById('messagesList');
    messagesList.innerHTML = '';
    
    if (filteredMessages.length === 0) {
        document.getElementById('noMessages').classList.remove('hidden');
    } else {
        filteredMessages.forEach(message => {
            const messageElement = createMessageElement(message);
            messagesList.appendChild(messageElement);
        });
    }
    
    console.log('Mensajes mostrados exitosamente');
}

function createMessageElement(message) {
    const div = document.createElement('div');
    const isUnread = !message.is_read;
    div.className = `bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-200 cursor-pointer ${isUnread ? 'border-papyrus-red bg-red-50' : ''}`;
    div.onclick = () => {
        console.log('Click en mensaje:', message.id);
        openMessageDetail(message.id);
    };
    
    const statusColor = getStatusColor(message.status);
    const statusText = getStatusText(message.status);
    const typeIcon = getTypeIcon(message.message_type);
    
    div.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
                <div class="bg-gray-100 rounded-lg p-2">
                    ${typeIcon}
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <h4 class="text-sm font-medium text-gray-900 truncate">${message.subject}</h4>
                            ${isUnread ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-papyrus-red text-white">Nuevo</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-500 line-clamp-2">${message.content}</p>
                        <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-gray-500">
                            <span class="flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                ${message.customer_name || 'Sistema'}
                            </span>
                            <span class="flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ${formatDate(message.created_at)}
                            </span>
                            ${message.package_guide_number ? `
                            <span class="flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                ${message.package_guide_number}
                            </span>` : ''}
                        </div>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${statusText}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return div;
}

function getTypeIcon(type) {
    switch(type) {
        case 'customer_inquiry':
            return '<svg class="w-6 h-6 text-papyrus-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        case 'internal':
            return '<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>';
        case 'support':
            return '<svg class="w-6 h-6 text-papyrus-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>';
        case 'system':
            return '<svg class="w-6 h-6 text-papyrus-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>';
        default:
            return '<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>';
    }
}

function openMessageDetail(messageId) {
    console.log('Abriendo detalle del mensaje:', messageId);
    currentMessageId = messageId;
    
    const token = getAuthToken();
    
    if (!token) {
        console.error('No hay token de autenticación disponible');
        window.location.href = '/auth/login';
        return;
    }
    
    // Mostrar loading en el modal
    const detailDiv = document.getElementById('messageDetail');
    detailDiv.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-papyrus-blue mx-auto"></div>
            <p class="mt-2 text-sm text-gray-500">Cargando mensaje...</p>
        </div>
    `;
    
    const modal = document.getElementById('messageModal');
    modal.classList.remove('hidden');
    
    fetch(`/api/messages/${messageId}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Datos del mensaje recibidos:', data);
        
        const statusColor = getStatusColor(data.status);
        const statusText = getStatusText(data.status);
        
        detailDiv.innerHTML = `
            <!-- Header con información básica -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-medium text-gray-900">${data.subject}</h2>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                            ${statusText}
                        </span>
                        ${data.status !== 'closed' ? `
                        <button id="closeMessageBtn" 
                                class="inline-flex items-center px-3 py-1 border border-gray-300 rounded-lg text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
                                onclick="closeMessage('${data.id}')">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Cerrar
                        </button>
                        ` : ''}
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="text-gray-700">${data.customer_name || 'Sin nombre'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        <span class="text-gray-700">${data.customer_phone || 'Sin teléfono'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span class="text-gray-700">${data.customer_email || 'Sin email'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-gray-700">${formatDate(data.created_at)}</span>
                    </div>
                </div>
            </div>
            
            ${data.package_guide_number || data.package_tracking_code ? `
            <!-- Información del paquete -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Información del Paquete</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    ${data.package_guide_number ? `
                    <div>
                        <span class="text-gray-500">Número de Guía:</span>
                        <span class="ml-2 font-medium text-gray-900">${data.package_guide_number}</span>
                    </div>
                    ` : ''}
                    ${data.package_tracking_code ? `
                    <div>
                        <span class="text-gray-500">Código de Tracking:</span>
                        <span class="ml-2 font-medium text-gray-900">${data.package_tracking_code}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}
            
            <!-- Mensaje del cliente -->
            <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Mensaje del Cliente</h3>
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${data.content}</p>
                </div>
            </div>
            
            ${data.admin_response ? `
            <!-- Respuesta del administrador -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Respuesta del Administrador</h3>
                <p class="text-sm text-gray-700 whitespace-pre-wrap mb-3">${data.admin_response}</p>
                <p class="text-xs text-gray-500">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    ${data.responded_by_name} - ${formatDate(data.responded_at)}
                </p>
            </div>
            ` : ''}
        `;
        
        // Mostrar/ocultar formulario de respuesta
        const responseForm = document.getElementById('responseForm');
        if (data.status === 'pending' || data.status === 'in_progress') {
            responseForm.classList.remove('hidden');
        } else {
            responseForm.classList.add('hidden');
        }
        
        console.log('Modal mostrado exitosamente');
    })
    .catch(error => {
        console.error('Error cargando detalle del mensaje:', error);
        detailDiv.innerHTML = `
            <div class="text-center py-8">
                <div class="bg-red-100 rounded-lg p-3 inline-flex mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Error al cargar mensaje</h3>
                <p class="mt-2 text-sm text-gray-500">No se pudo cargar el detalle del mensaje.</p>
            </div>
        `;
    });
}

function sendResponse() {
    const responseText = document.getElementById('responseText').value.trim();
    
    if (!responseText) {
        alert('Por favor escribe una respuesta');
        return;
    }
    
    fetch(`/api/messages/${currentMessageId}/respond`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        },
        body: JSON.stringify({
            response: responseText
        })
    })
    .then(response => response.json())
    .then(data => {
        closeModal();
        loadMessageStats();
        loadMessages();
        alert('Respuesta enviada exitosamente');
    })
    .catch(error => {
        console.error('Error enviando respuesta:', error);
        alert('Error al enviar la respuesta');
    });
}

function closeModal() {
    document.getElementById('messageModal').classList.add('hidden');
    document.getElementById('responseText').value = '';
    currentMessageId = null;
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('searchFilter').value = '';
    loadMessages();
}

function closeMessage(messageId) {
    const token = getAuthToken();
    
    if (!token) {
        console.error('No hay token de autenticación disponible');
        return;
    }
    
    if (!confirm('¿Estás seguro de que quieres cerrar este mensaje?')) {
        return;
    }
    
    fetch(`/api/messages/${messageId}/close`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Mensaje cerrado exitosamente:', data);
        closeModal();
        loadMessageStats();
        loadMessages();
        alert('Mensaje cerrado exitosamente');
    })
    .catch(error => {
        console.error('Error cerrando mensaje:', error);
        alert('Error al cerrar el mensaje');
    });
}

function getStatusColor(status) {
    switch(status) {
        case 'pending': return 'bg-red-100 text-papyrus-red';
        case 'in_progress': return 'bg-blue-100 text-papyrus-blue';
        case 'resolved': return 'bg-green-100 text-papyrus-green';
        case 'closed': return 'bg-gray-100 text-gray-700';
        default: return 'bg-gray-100 text-gray-700';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'pending': return 'Pendiente';
        case 'in_progress': return 'En Progreso';
        case 'resolved': return 'Resuelto';
        case 'closed': return 'Cerrado';
        default: return status;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-CO', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getAuthToken() {
    // Intentar obtener token desde localStorage primero
    let token = localStorage.getItem('access_token');
    
    // Si no está en localStorage, intentar desde cookies
    if (!token) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; access_token=`);
        if (parts.length === 2) {
            token = parts.pop().split(';').shift();
        }
    }
    
    return token;
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}
</script>
{% endblock %}
